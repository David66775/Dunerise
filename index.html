<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- Correct browser-safe Y.js + WebRTC scripts -->
<script src="https://cdn.jsdelivr.net/npm/yjs@13.5.39/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.10/dist/y-webrtc.js"></script>

<title>Dunerise Multiplayer</title>
<style>
    body { margin: 0; overflow: hidden; background-color: #eee; }
    canvas { display: block; background-color: skyblue;}

    /* Hamburger Menu Icon Styling */
    .menu-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        transition: transform 0.3s;
    }
    .menu-toggle:hover { transform: scale(1.1); }
    .bar {
        width: 60%;
        height: 4px;
        background-color: white;
        margin: 3px 0;
        transition: 0.4s;
    }
    .menu-toggle.active .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.active .bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
    .menu-toggle.active .bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

    /* Menu Container Styling */
    .menu-container {
        position: fixed;
        top: 0;
        right: -300px; 
        width: 300px;
        height: 100%;
        background-color: rgba(50, 50, 50, 0.95);
        color: white;
        padding: 20px;
        box-sizing: border-box;
        transition: right 0.4s ease;
        z-index: 5;
        font-family: sans-serif;
    }
    .menu-container.active { right: 0; }
    .menu-container h2 { margin-top: 50px; }
    .menu-container div { margin-bottom: 10px; padding: 5px; background-color: rgba(255,255,255,0.1); border-radius:4px; }
    .menu-container button { margin: 5px 2px; padding: 5px 10px; border:none; border-radius:4px; cursor:pointer; background-color:#666; color:white; }
    .menu-container button:hover { background-color:#888; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<!-- Hamburger Menu Icon -->
<div class="menu-toggle" id="menuToggle">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
</div>

<!-- Sliding Stats Menu -->
<div class="menu-container" id="statsMenu">
    <h2>Game Stats</h2>
    <div>High Score: <span id="highScore">0</span></div>
    <div>Total Movement: <span id="totalMovement">0</span></div>
    <div>Times Played: <span id="timesPlayed">0</span></div>

    <hr>

    <h3>Number of Local Players</h3>
    <div>
      <button onclick="setPlayerCount(1)">1</button>
      <button onclick="setPlayerCount(2)">2</button>
      <button onclick="setPlayerCount(3)">3</button>
      <button onclick="setPlayerCount(4)">4</button>
    </div>

    <hr>

    <h3>Online Channel</h3>
    <input 
        type="number"
        id="channel-input"
        placeholder="Channel number"
        style="width:90%;padding:5px;margin-bottom:10px;"
    >

    <button onclick="hostChannel()">Host</button>
    <button onclick="joinChannel()">Join</button>

    <div style="font-size:12px;margin-top:5px;">
        Up to 4 players per channel
    </div>
</div>

<script>
/* ------------------ GAME SETUP ------------------ */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const menuToggle = document.getElementById('menuToggle');
const statsMenu = document.getElementById('statsMenu');

let canvasWidth = window.innerWidth;
let canvasHeight = window.innerHeight;
canvas.width = canvasWidth;
canvas.height = canvasHeight;

const world = new Map();
const CHUNK_SIZE = 512;
const baseTerrainHeight = canvasHeight * 0.6;
const SPAWN_X = 50;

let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let totalMovement = parseInt(localStorage.getItem('totalMovement')) || 0;
let timesPlayed = parseInt(localStorage.getItem('timesPlayed')) || 0;

let previousWorldX = SPAWN_X;

const playerConfigs = [
    { jump: 'w', left: 'a', right: 'd', color: '#ff5733' },
    { jump: '5', left: 'r', right: 'y', color: '#006400' },
    { jump: 'o', left: 'k', right: ';', color: '#3357ff' },
    { jump: 'f', left: 'c', right: 'b', color: '#ff33aa' },
];

let players = [];
let maxPlayers = 1;

/* ------------------ MULTIPLAYER (YJS) ------------------ */

let ydoc;
let provider;
let yPlayers;
let myPlayerIndex = 0;
let isHost = false;

function hostChannel(){
    const channelNumber = parseInt(document.getElementById("channel-input").value);

    if(isNaN(channelNumber)){
        alert("Enter a valid channel number!");
        return;
    }

    isHost = true;

    ydoc = new Y.Doc();
    provider = new WebrtcProvider("dunerise-" + channelNumber, ydoc);
    yPlayers = ydoc.getArray("players");

    if(yPlayers.length === 0){
        for(let i=0;i<4;i++){
            yPlayers.push([SPAWN_X, 0, false, 0]);
        }
    }

    myPlayerIndex = 0;

    maxPlayers = 4;
    restartGame();

    console.log("Channel hosted:", channelNumber);
}

function pickFreeSlot(){
    for(let i = 0; i < yPlayers.length; i++){
        let p = yPlayers.get(i);
        if(p[0] === SPAWN_X && p[1] === 0){
            return i;
        }
    }
    return -1;
}

function joinChannel(){
    const channelNumber = parseInt(document.getElementById("channel-input").value);

    if(isNaN(channelNumber)){
        alert("Enter a valid channel number!");
        return;
    }

    isHost = false;

    ydoc = new Y.Doc();
    provider = new WebrtcProvider("dunerise-" + channelNumber, ydoc);
    yPlayers = ydoc.getArray("players");

    const waitForHost = setInterval(() => {
        if(yPlayers.length >= 1){
            clearInterval(waitForHost);
            myPlayerIndex = pickFreeSlot();
            maxPlayers = 4;
            restartGame();
            console.log("Joined channel", channelNumber, "Slot:", myPlayerIndex);
        }
    }, 300);
}

/* ------------------ GAME LOGIC ------------------ */

function setPlayerCount(count){
    maxPlayers = count;
    restartGame();
}

function restartGame(){
    players = [];
    for(let i=0;i<maxPlayers;i++){
        players.push({
            id:i,
            x:50,
            y:0,
            radius:10,
            speed:5,
            vx:0,
            vy:0,
            gravity:0.5,
            onGround:false,
            worldX:SPAWN_X,
            color:playerConfigs[i].color,
            score:0
        });
    }
}

const keys={};

function updatePlayers(){
    players.forEach((player,i)=>{
        const config = playerConfigs[i];

        if(keys[config.left]) player.vx = -player.speed;
        else if(keys[config.right]) player.vx = player.speed;
        else player.vx = 0;

        if(keys[config.jump] && player.onGround){
            player.vy=-10;
            player.onGround=false;
        }

        player.worldX += player.vx;
        player.y += player.vy;

        if(player.y > canvasHeight){
            player.y = 0;
            player.worldX = SPAWN_X;
        }

        player.vy += player.gravity;
    });
}

function drawPlayers(){
    players.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.worldX, p.y, p.radius, 0, Math.PI*2);
        ctx.fillStyle = p.color;
        ctx.fill();
    });
}

function gameLoop(){
    ctx.clearRect(0,0,canvasWidth,canvasHeight);
    updatePlayers();
    drawPlayers();
    requestAnimationFrame(gameLoop);
}

/* ------------------ INPUT ------------------ */

document.addEventListener('keydown',(e)=>{ keys[e.key.toLowerCase()]=true; });
document.addEventListener('keyup',(e)=>{ keys[e.key.toLowerCase()]=false; });

/* ------------------ MENU ------------------ */

menuToggle.addEventListener('click',()=>{
    menuToggle.classList.toggle('active');
    statsMenu.classList.toggle('active');
});

/* ------------------ START ------------------ */

restartGame();
gameLoop();
</script>
</body>
</html>
