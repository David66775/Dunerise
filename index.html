<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dunerise Multiplayer</title>

<!-- Correct browser-friendly Y.js + WebRTC versions -->
<script src="https://cdn.jsdelivr.net/npm/yjs@13.5.39/dist/yjs.js"></script>
<script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.3.10/dist/y-webrtc.js"></script>

<style>
    body { margin:0; overflow:hidden; background:#87ceeb; }
    canvas { display:block; }

    .menu {
        position:absolute;
        top:20px;
        right:20px;
        background:white;
        padding:12px;
        border-radius:10px;
        border:1px solid #aaa;
        font-family:Arial, sans-serif;
    }
    button { margin:4px 0; width:120px; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="1280" height="720"></canvas>

<div class="menu">
    <input id="channel-input" type="number" placeholder="Channel #" style="width:110px;">
    <br>
    <button onclick="hostChannel()">Host</button>
    <button onclick="joinChannel()">Join</button>
</div>

<script>
// =====================================================================
//  GLOBALS
// =====================================================================
let doc = null;
let provider = null;
let players = {};
let myId = Math.random().toString(36).slice(2);
let channel = null;

// Reference shared Y map
let yPlayers = null;

// =====================================================================
//  SETUP CANVAS + DRAW LOOP (LANDSCAPE VISIBLE)
// =====================================================================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function draw() {
    requestAnimationFrame(draw);

    // Sky
    ctx.fillStyle = "#87ceeb";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Sand ground
    ctx.fillStyle = "#E5C56B";
    ctx.fillRect(0, canvas.height * 0.75, canvas.width, canvas.height * 0.25);

    // Cactus (just decoration)
    ctx.fillStyle = "#3B7A3A";
    ctx.fillRect(200, canvas.height * 0.55, 40, 120);

    // Draw each player
    for (let id in players) {
        let p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 40, 40);
    }
}
draw();

// =====================================================================
//  MULTIPLAYER SETUP FUNCTIONS
// =====================================================================

function initSharedState() {
    yPlayers = doc.getMap("players");

    // Load existing players
    yPlayers.forEach((data, id) => {
        players[id] = data;
    });

    // Listen for updates
    yPlayers.observe(event => {
        event.changes.keys.forEach((change, key) => {
            if (change.action === "add" || change.action === "update") {
                players[key] = yPlayers.get(key);
            } else if (change.action === "delete") {
                delete players[key];
            }
        });
    });

    // Spawn yourself
    yPlayers.set(myId, {
        x: 400 + Math.random() * 200,
        y: 500,
        color: "#" + Math.floor(Math.random() * 0xffffff).toString(16)
    });
}

function hostChannel() {
    channel = document.getElementById("channel-input").value;
    if (!channel) {
        alert("Enter a channel number first.");
        return;
    }

    doc = new Y.Doc();
    provider = new WebrtcProvider("dunerise_" + channel, doc);

    initSharedState();
    console.log("Hosting channel:", channel);
}

function joinChannel() {
    channel = document.getElementById("channel-input").value;
    if (!channel) {
        alert("Enter a channel number first.");
        return;
    }

    doc = new Y.Doc();
    provider = new WebrtcProvider("dunerise_" + channel, doc);

    initSharedState();
    console.log("Joined channel:", channel);
}

// =====================================================================
//  MOVEMENT
// =====================================================================

document.addEventListener("keydown", e => {
    if (!yPlayers) return;

    let me = yPlayers.get(myId);
    if (!me) return;

    if (e.key === "ArrowLeft")  me.x -= 10;
    if (e.key === "ArrowRight") me.x += 10;

    yPlayers.set(myId, me);
});
</script>

</body>
</html>
